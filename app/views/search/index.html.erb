<%= stylesheet_link_tag 'paginate' %>
<%= stylesheet_link_tag 'advanced_search' %>
<%= stylesheet_link_tag 'facets' %>
<h1>Advanced Search</h1>
<div id = "advance_search" class = "top_bar">
	<%= form_tag search_index_path, :id => 'search_check_form', method: :get do %>
	  <%= text_field_tag :adv_search, params[:adv_search], :placeholder => 'Search' %>
	  <%= submit_tag "Search", name: nil %>
    <div id = "options_list" >
      <table class="options_table">
        <% @checkbox_options.each_with_index do |(key, display_name), index| %>
          <tr>
            <td><%= label_tag display_name %>:</td>
            <td>
              <% if params[:search_using].nil? or (!params[:search_using][key].blank?) %>
                <%= check_box_tag "search_using[#{key}]", 1, true %>
              <% else %>
                <%= check_box_tag "search_using[#{key}]", 1 %>
              <% end %>
            </td>
          </tr>
        <% end %>
    </table>
  <%=label_tag "Document Type: " %><%=collection_select(:doc_info, :document_type_id, DocumentType.where(retired: false), :id, :name, params[:doc_info].nil? ? {:include_blank => 'All'} : {:selected => params[:doc_info][:document_type_id], :include_blank => 'All'}, {:class => "dropdowns"})%>
  </br>
  <%=label_tag "Department: " %><%=collection_select(:doc_info, :department, Department.where(retired: false).order('name ASC'), :id, :name, params[:doc_info].nil? ? {:include_blank => 'All'} : {:selected => params[:doc_info][:department], :include_blank => 'All'}, {:class => "dropdowns"})%>
</br>
</br>
  <span id="date_format"> Date formats accepted: YYYY, YYYY-MM, YYYY-MM-DD </span>
  <div id="defense_date_range_div">
    <%= label_tag "Defense Date:" %>
    <%= label_tag "Before ", nil, :id => 'before_label' %>
    <%= text_field_tag :defense_date_before, params[:defense_date_before], :class=>"date_range_input" %> 

    <%= label_tag "After", nil %>
    <%= text_field_tag :defense_date_after, params[:defense_date_after], :class=>"date_range_input" %>
  </div>
  <div id="release_date_range_div">
    <%= label_tag "Release Date:" %>
    <%= label_tag "Before ", nil, :id => 'before_label' %>
    <%= text_field_tag :release_date_before, params[:release_date_before], :class=>"date_range_input" %> 

    <%= label_tag "After", nil %>
    <%= text_field_tag :release_date_after, params[:release_date_after], :class=>"date_range_input" %>
  </div>
  </div>
    <%= label_tag "ETD:" %> <%= check_box_tag "type_etd", 1, params[:type_etd].present?, :class => 'etd_btd_check' %>
    <%= label_tag "BTD:" %> <%= check_box_tag "type_btd", 1, params[:type_btd].present?, :class => 'etd_btd_check' %>
	  <%= hidden_field_tag :per_page, params[:per_page] %>
  <% end %>
	<br>
</div>
<div id="page_pref" class="top_bar"> 
	<%= form_tag search_index_path, :id => 'page_pref_form', :method => 'get' do %> 
  Results Per Page: <%= select_tag :per_page, options_for_select(%w[10 20 50 100], @per_page),
         :onchange => "submit_form()" %>
         <%= hidden_field_tag :adv_search, params[:adv_search] %>
         <% if !params[:search_using].blank? %>
           <% params[:search_using].each do |k, v| %>
              <%= hidden_field_tag "search_using[#{k}]", v, :class => 'pref_removable' %>
           <%end%>
         <%end%>
  <% end %>
</div>

<!-- Render the facets -->
<%= render '/search/facets', :search => @search %>

<div id="results">
<% if @result == "no_search" %>
  <!-- Render nothing below search params if they haven't searched anything -->
<% elsif @result == "exception" %>
  <h3 class="clear_left"> Could Not Complete Request - <%= @exception_message %> </h3>
<% elsif @result == "none_found" %>
  <br>
  <br>
  <h3 class="clear_left"> No Records Found </h3>
<% else %>
  <% if !@results_info.blank? %>
  <h5 id="total" class="clear_left"><%= @results_info %></h5>
  <% end %>
  <div id="paginate_outer">
    <div id="paginate_inner">
      <%= will_paginate @result %>
    </div>
    <div class="clear"></div>
  </div>
  <div id="results_list" >
    <% i = 1 %>
    <% @search.each_hit_with_result do |hit, etd| %>
      <% creators = Person.where(id: etd.people_roles.where(role_id: Role.where(group: 'Creators')).pluck(:person_id)).order('last_name ASC') %>
      <% if i == @result.size %>
      <!-- Avoids border on bottom -->
        <div class="list_entry_last">
      <% else %>
        <div class="list_entry">
      <% end %>
        <%= render '/search/display_etd', :etd => etd, :iteration => i %>
        <% if !hit.highlight(:etd_attachment).nil? %>
          <% highlighted = hit.highlight(:etd_attachment).format { |fragment| content_tag(:em, fragment) } %>
          <p class="etd_fulltext"><%= "\"#{highlighted}\"".html_safe %></p>
        <% end %>
        </div>
      <% i += 1 %>
    <% end %>
  </div>
  <br />
  <div id="paginate_outer">
    <div id="paginate_inner">
      <%= will_paginate @result %>
    </div>
    <div class="clear"></div>
  </div>
<% end %>
<br />
</div>