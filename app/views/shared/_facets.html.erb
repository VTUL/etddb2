<% if !search.nil? %>
  <div id="facets" class="clear_left">

    <%# Facets that need unique modifications to the params hash %>

    <h3 class="facet_title">Author</h3>
    <ul <% if params[:author].blank? %>
          <%# List to be hidden by javascript on page load %>
          class = "minified"
        <% end %>> 
      <% for row in search.facet(:author).rows %>
        <li>
          <% if params[:author].blank? %>
            <%# Reload page with the given author ID %>
            <%= link_to row.value, params.except(:page).merge({:author => row.value}) %> (<%= row.count %>)
          <% else %>
            <%# Remove this author ID from the params and resubmit %>
            <strong><%= row.value %></strong> (<%= link_to "remove", params.except(:page).merge({:author => nil}) %>)
          <% end %>
        </li>
      <% end %>
    </ul>
    <h3 class="facet_title">Document Type</h3>

    <% if params[:doc_info].blank? or params[:doc_info][:document_type_id].blank? %>
      <%# List to be hidden by javascript %>
      <ul class = "minified" >
    <% else %>
      <ul>
    <% end %>
    <% for row in search.facet(:document_type_id).rows %>
      <% if !DocumentType.exists?(:id => row.value) %>
        <% next %>
      <% end %>
      <li>
        <% if params[:doc_info].blank? %>
          <%= link_to DocumentType.find(row.value).name, params.except(:page).merge({:doc_info => {:document_type_id => row.value}}) %> (<%= row.count %>)
        <% elsif params[:doc_info][:document_type_id].blank? %>
          <%= link_to DocumentType.find(row.value).name, params.except(:page).merge({:doc_info => params[:doc_info].merge({:document_type_id => row.value})}) %> (<%= row.count %>)
        <% else %>
          <%= content_tag(:strong, DocumentType.find(row.value).name, {:class=>"faceted_if_no_dropdown", :id=>row.value, :name=>"doc_info[document_type_id]"}) %> (<%= link_to "remove", params.except(:page).merge({:doc_info => params[:doc_info].merge({:document_type_id => nil})}) %>)
        <% end %>
      </li>
    <% end %>
  </ul>

  <h3 class="facet_title">Department</h3>

    <% if params[:doc_info].blank? or params[:doc_info][:department].blank? or params[:doc_info][:department].eql?([''])  %>
      <ul class = "minified" >
    <% else %>
      <ul>
    <% end %>
    <%# Loop through letter groups with departments listed under them. %>
    <%# loadDepartments found in sunspot_searchable controller. %>
    <% for letter_group in loadDepartments(@search.facet(:department).rows) %>
      <li>
        <h4 class="facet_title"><%= "#{letter_group[0]}" %></h4>
        <% if letter_group[1].reject{|dept| dept.selected.eql?(false)}.length > 0 %> 
          <ul>
        <% else %>
          <ul class = "minified" >
        <% end %>
        
        <%# Loop through departments for each letter %>
        <% for dept in letter_group[1].sort{|x, y| x.name <=> y.name} %>
          <li class="indented_list_elem">
            <% if params[:doc_info].blank? %>
              <%= link_to dept.name, params.except(:page).merge({:doc_info => {:department => [dept.id]}}) %> (<%= dept.count %>)
            <% elsif params[:doc_info][:department].blank? %>
              <%= link_to dept.name, params.except(:page).merge({:doc_info => params[:doc_info].merge({:department => [dept.id]})}) %> (<%= dept.count %>)
            <% else %>
              <%# Something exists in params[:doc_info][:department] %>
              <% temp_params = Array.new(params[:doc_info][:department]) %>
              <% if dept.selected %>
                <% temp_params.delete(dept.id.to_s) %>
                <%=content_tag(:strong, dept.name, {:class=>"multi_selectable", :id=>dept.id, :name=>"doc_info[department][]"})%> (<%= link_to "remove", params.except(:page).merge({:doc_info => params[:doc_info].merge({:department => temp_params})}) %>)
              <% else %>
                <%= link_to dept.name, params.except(:page).merge({:doc_info => params[:doc_info].merge({:department => temp_params.push(dept.id)})}) %> (<%= dept.count %>)
              <% end %>
            <% end %>
          </li>
        <% end %>
        </ul>
      </li>
    <% end %>
  </ul>

  <%# Facets that require no unique modifications to params hash %>

  <h3 class="facet_title">Defense Year</h3>
  <%= render '/shared/facets_regular_display', :search=>search, :facet_type=>:defense_year, :sort => 'DESC' %>

  <h3 class="facet_title">Release Year</h3>
  <%= render '/shared/facets_regular_display', :search=>search, :facet_type=>:release_year, :sort => 'DESC' %>

  <% if isUserAdmin %>
    <h3 class="facet_title">Creation Year</h3>
    <%= render '/shared/facets_regular_display', :search=>search, :facet_type=>:creation_year, :sort => 'DESC' %>

    <h3 class="facet_title">Approval Year</h3>
    <%= render '/shared/facets_regular_display', :search=>search, :facet_type=>:approval_year, :sort => 'DESC' %>
  <% end %>

  <h3 class="facet_title">File Type</h3>
  <%= render '/shared/facets_regular_display', :search=>search, :facet_type=>:file_type, :sort => 'ASC' %>

  </div>
<% end %>